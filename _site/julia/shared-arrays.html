<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>UVic Spring School 2023 - SharedArrays.jl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//img/sfu_favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/sfudrac_logo.png" alt="SFU &amp; DRAC logos" class="navbar-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../bash/index.html">
 <span class="menu-text">Bash</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../hpc/index.html">
 <span class="menu-text">HPC</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_intro/index.html">
 <span class="menu-text">Intro R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_parallel/index.html">
 <span class="menu-text">Parallel R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../julia/index.html">
 <span class="menu-text">Parallel Julia</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../ml/index.html">
 <span class="menu-text">PyTorch</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../scivis/index.html">
 <span class="menu-text">ParaView</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title"><em>On this page:</em></h2>
   
  <ul>
  <li><a href="#local-vs-shared-arrays-in-julia" id="toc-local-vs-shared-arrays-in-julia" class="nav-link active" data-scroll-target="#local-vs-shared-arrays-in-julia">Local vs shared arrays in Julia</a></li>
  <li><a href="#shared-arrays" id="toc-shared-arrays" class="nav-link" data-scroll-target="#shared-arrays">Shared arrays</a></li>
  <li><a href="#partition-of-shared-arrays" id="toc-partition-of-shared-arrays" class="nav-link" data-scroll-target="#partition-of-shared-arrays">Partition of shared arrays</a></li>
  <li><a href="#another-way-to-avoid-a-race-condition-use-parallel-for-loop" id="toc-another-way-to-avoid-a-race-condition-use-parallel-for-loop" class="nav-link" data-scroll-target="#another-way-to-avoid-a-race-condition-use-parallel-for-loop">Another way to avoid a race condition: use parallel <code>for</code> loop</a></li>
  <li><a href="#pitfall-of-using-shared-objects" id="toc-pitfall-of-using-shared-objects" class="nav-link" data-scroll-target="#pitfall-of-using-shared-objects">Pitfall of using shared objects</a></li>
  <li><a href="#solving-1d-heat-equation-using-shared-array" id="toc-solving-1d-heat-equation-using-shared-array" class="nav-link" data-scroll-target="#solving-1d-heat-equation-using-shared-array">Solving 1D heat equation using shared array</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">SharedArrays.jl</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="local-vs-shared-arrays-in-julia" class="level3">
<h3 class="anchored" data-anchor-id="local-vs-shared-arrays-in-julia">Local vs shared arrays in Julia</h3>
<p>Let’s reiterate this concept in Julia. Any variables created in the control process are only accessible on the control process. In order to make the content stored in a variable accessible by another process, we either need to copy it to the other process or use a shared variable.</p>
<p>In the following example</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">zeros</span>(n)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@distributed</span> <span class="cf">for</span> i<span class="op">=</span><span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    a[i] <span class="op">=</span> i</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we attempt to assign values to array <code>a</code> concurrently by distributing the task in the loop to workers randomly (determined by Julia). But this is not going to happen</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(a)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>[<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is because, the distributed assignments took place on workers, not on the control process. Let’s see what’s on workers</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">show</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(a)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">remotecall_fetch</span>(show,p)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output might surprise us</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 2:    [1.0, 2.0, 3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 3:    [0.0, 0.0, 0.0, 4.0, 5.0, 6.0, 0.0, 0.0, 0.0, 0.0]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 4:    [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 7.0, 8.0, 0.0, 0.0]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 5:    [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.0, 10.0]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Two things worth noting here. First, <code>a</code> gets copied on the workers, otherwise, the workers will have nothing to work on as they don’t have access to variables defined on the control process. Second, the result shows, each worker does only a portion of the work, thanks to the rule of <code>@distributed</code>. As a result, workers have different “images” of the variable <code>a</code> afterwards.</p>
<p>With package <code>SharedArrays</code>, a shared array of type <code>SharedArray</code> will have a universal view across all process. The following example illustrates the effect of using shared arrays</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Float64}</span>(n)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="pp">@distributed</span> <span class="cf">for</span> i<span class="op">=</span><span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    a[i] <span class="op">=</span> i</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="bu">SharedArrays</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="fu">showa</span>()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(a)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">remotecall_fetch</span>(showa,p)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is the output</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 2:    [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 3:    [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 4:    [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 5:    [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Every worker has the same content. Note in the above we used <code>remotecall</code> rather than the macro <code>@fetchfrom</code>, as seen elsewhere. We will explain why in the section of pitfalls.</p>
</section>
<section id="shared-arrays" class="level3">
<h3 class="anchored" data-anchor-id="shared-arrays">Shared arrays</h3>
<p>Unlike distributed <strong>DArray</strong> from <strong>DistributedArrays.jl</strong>, a <strong>SharedArray</strong> object is stored in full on the control process, but it is shared across all workers on the same node, with a significant cache on each worker. <strong>SharedArrays</strong> package is part of Julia’s Standard Library (comes with the language).</p>
<ul>
<li>Similar to DistributedArrays, you can read elements using their global indices from any worker.</li>
<li>Unlike with DistributedArrays, with SharedArrays you can <strong>write into any part of the array from any worker</strong> using their global indices. This makes it very easy to parallelize any serial code.</li>
</ul>
<p>There are certain downsides to <strong>SharedArray</strong> (compared to <strong>DistributedArrays.jl</strong>): 1. The ability to write into the same array elements from multiple processes creates the potential for a race condition and indeterministic outcome with a poorly written code! 1. You are limited to a set of workers on the same node (due to SharedArray’s intrinsic implementation). 1. You will have very skewed (non-uniform across processes) memory usage.</p>
<p>Let’s start with serial Julia (<code>julia</code>) and initialize a 1D shared array:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributed</span>, <span class="bu">SharedArrays</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">addprocs</span>(<span class="fl">4</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Float64}</span>(<span class="fl">30</span>);</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>a[<span class="op">:</span>] <span class="op">.=</span> <span class="fl">1.0</span>           <span class="co"># assign from the control process</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">2</span> <span class="fu">sum</span>(a)   <span class="co"># correct (30.0)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> <span class="fu">sum</span>(a)   <span class="co"># correct (30.0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@sync</span> <span class="pp">@spawnat</span> <span class="fl">2</span> a[<span class="op">:</span>] <span class="op">.=</span> <span class="fl">2.0</span>   <span class="co"># can assign from any worker!</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> <span class="fu">sum</span>(a)            <span class="co"># correct (60.0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can use a function to initialize an array, however, pay attention to the result:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Int64}</span>((<span class="fl">1000</span>), init <span class="op">=</span> x <span class="op">-&gt;</span> x <span class="op">.=</span> <span class="fl">0</span>);    <span class="co"># use a function to initialize `b`</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Int64}</span>((<span class="fl">1000</span>), init <span class="op">=</span> x <span class="op">-&gt;</span> x <span class="op">.+=</span> <span class="fl">1</span>)   <span class="co"># each worker updates the entire array in-place!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p><strong>Key idea:</strong> each worker runs this function!</p>
</blockquote>
<p>Let’s fill each element with its corresponding myd() value:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="fu">println</span>(<span class="fu">myid</span>())     <span class="co"># let's use these IDs in the next function</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Int64}</span>((<span class="fl">20</span>), init <span class="op">=</span> x <span class="op">-&gt;</span> x <span class="op">.=</span> <span class="fu">myid</span>())   <span class="co"># indeterminate outcome! each time a new result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each worker updates every element, but the order in which they do this varies from one run to another, producing indeterminate outcome. Let’s see how to avoid such unexpected outcomes.</p>
</section>
<section id="partition-of-shared-arrays" class="level3">
<h3 class="anchored" data-anchor-id="partition-of-shared-arrays">Partition of shared arrays</h3>
<p>Julia defines a “virtual boundary” around the portion of a shared array mapped to a worker. Let’s take a look at the following example. We create a shared array <code>u</code> of length 17.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="fl">17</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Float64}</span>(n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we use function <code>localindices</code> to see the start and end indices of the partitions of the array object <code>u</code>. First we run this on the control process</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">localindices</span>(u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output might be a little surprise</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">1:0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next we run <code>localindices(u)</code> on each worker</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@fetchfrom</span> p <span class="fu">println</span>(<span class="fu">localindices</span>(u))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now the output is what we expected</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 2:    1:4</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 3:    5:8</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 4:    9:12</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 5:    13:17</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now come back to the task we want to accomplish while we hit the unexpected outcomes. What we really want is each worker should fill only its assigned block (parallel init, same result every time. This can be achieved as follows</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Int64}</span>((<span class="fl">20</span>), init <span class="op">=</span> x <span class="op">-&gt;</span> x[<span class="fu">localindices</span>(x)] <span class="op">.=</span> <span class="fu">myid</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="another-way-to-avoid-a-race-condition-use-parallel-for-loop" class="level3">
<h3 class="anchored" data-anchor-id="another-way-to-avoid-a-race-condition-use-parallel-for-loop">Another way to avoid a race condition: use parallel <code>for</code> loop</h3>
<p>Let’s initialize a 2D SharedArray:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Float64}</span>(<span class="fl">100</span>,<span class="fl">100</span>);</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@distributed</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>     <span class="co"># parallel for loop split across all workers</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        a[i,j] <span class="op">=</span> <span class="fu">myid</span>()           <span class="co"># ID of the worker that initialized this element</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> i <span class="fu">println</span>(<span class="fu">localindices</span>(a))   <span class="co"># weird: shows 1D indices for 2D array</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>a                           <span class="co"># available on all workers</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>a[<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>]                <span class="co"># on the control process</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">2</span> a[<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>]   <span class="co"># on worker 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="pitfall-of-using-shared-objects" class="level3">
<h3 class="anchored" data-anchor-id="pitfall-of-using-shared-objects">Pitfall of using shared objects</h3>
<p>Let’s have a look at the following example, restart Julia with <code>julia -p 4</code></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Float64}</span>(<span class="fl">5_000_000</span>);</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">varinfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will see the output looks like this</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>                    size summary                              </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">––––––––––––––––</span> ––––––––––– –––––––––––––––––––––––––––––––––––––</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">A</span>                 38.148 MiB 5000000-element SharedVector{Float64}</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Base</span>                         Module                               </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Core</span>                         Module                               </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Distributed</span>       39.861 MiB Module                               </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">InteractiveUtils</span> 253.909 KiB Module                               </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Main</span>                         Module                               </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ans</span>               38.148 MiB 5000000-element SharedVector{Float64}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we run <code>varinfo()</code> on a worker process, say, 3</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">InteractiveUtils</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> <span class="fu">varinfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we get</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>              size summary</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">–––––––––––</span> –––––––––– –––––––</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Base</span>                   Module </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Core</span>                   Module </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Distributed</span> 39.155 MiB Module </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Main</span>                   Module </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We do not see the variable <code>A</code> per se. But we do see the same amount of data 39.861 MiB claimed by <code>Distributed</code> as on the control process.</p>
<p>If we try to set the values in <code>A</code> on worker 3 to its worker ID with the following code</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">set_to_myid</span>()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">localindices</span>(A);</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    A[idx] <span class="op">.=</span> <span class="fu">myid</span>();</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> <span class="fu">set_to_myid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we will get the following error</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ERROR<span class="op">:</span> On worker <span class="fl">3</span><span class="op">:</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="dt">UndefVarError</span><span class="op">:</span> A not defined</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This suggests that, the data is shared across all processes, but the name space of the variable itself is not.</p>
<p>We now modify the function <code>set_to_myid</code> a bit as follows</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">set_to_myid</span>(a)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">localindices</span>(a);</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    a[idx] <span class="op">.=</span> <span class="fu">myid</span>();</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">remotecall_fetch</span>(set_to_myid,<span class="fl">3</span>,A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This time it should not give any error. The portion of <code>A</code> is properly set. If we check the output of <code>varinfo()</code> again, wee</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> <span class="fu">varinfo</span>()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  name              size summary                                      </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  ––––––––––– –––––––––– –––––––––––––––––––––––––––––––––––––––––––––</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Base</span>                   Module                                       </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Core</span>                   Module                                       </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Distributed</span> <span class="fl">39.159</span> MiB Module                                       </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Main</span>                   Module                                       </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  set_to_myid    <span class="fl">0</span> bytes set_to_myid (generic <span class="kw">function</span> with <span class="fl">2</span> methods)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Still, <code>A</code> is not present. But the assignment of worker ID to <code>A</code> on worker 3 has worked.</p>
<p>If we run the following command</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> A[<span class="fu">localindices</span>(A)] <span class="op">.=</span> <span class="fu">myid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>it works, but it has a different meaning. It copies <code>A</code> to worker 3 and performs the operation of assignments there. This becomes evident when we see the output of <code>varinfo</code> on worker 3</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>              size summary                                      </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">–––––––––––</span> –––––––––– –––––––––––––––––––––––––––––––––––––––––––––</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">A</span>           38.147 MiB 5000000-element SharedVector{Float64}        </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Base</span>                   Module                                       </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Core</span>                   Module                                       </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Distributed</span> 39.161 MiB Module                                       </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Main</span>                   Module                                       </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">set_to_myid</span>    0 bytes set_to_myid <span class="er">(</span><span class="ex">generic</span> function with 2 methods<span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The conclusion so far is, use <code>remotecall</code> to execute the code on workers. Use macros <code>@fetch</code> etc carefully.</p>
</section>
<section id="solving-1d-heat-equation-using-shared-array" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="solving-1d-heat-equation-using-shared-array">Solving 1D heat equation using shared array</h3>
<p>Consider a (simplified) physics problem: A rod of length <span class="math inline">\([-L,L]\)</span> heated in the middle, then the heat source is removed. The temperature distribution <span class="math inline">\(T(x,t)\)</span> across the rod over time can be simulated by the following equation</p>
<p>\[ T(x,t+t) = T(x-x,t) + T(x+x,t) \]</p>
<p>on a set of evenly spaced points apart by <span class="math inline">\(\Delta x\)</span>. The initial condition is shown in the diagram below. At <span class="math inline">\(t=0\)</span>, <span class="math inline">\(T(x,0) = T_0\)</span> for <span class="math inline">\(-h \leq x \leq h\)</span> and <span class="math inline">\(T(x,0) = 0\)</span> elsewhere.</p>
<p></p>
<p>At both ends, we impose the boundary conditions <span class="math inline">\(T(-L,t)=0\)</span> and <span class="math inline">\(T(L,t)=0\)</span>.</p>
<p>The solution of the temperature across the rod is a bell shaped curve being flattened over time. The figure below shows a snapshot of the solution (with <span class="math inline">\(T_0 = 1\)</span>) on an interval <span class="math inline">\([-1,1]\)</span> at certain time.</p>
<p></p>
<p>This example is used in many of our training courses, for example, MPI, Fortran and Python courses to illustrate parallel processing in advanced research computing. A more “accurate” formula involving three spatial points <span class="math inline">\(x_i - \Delta x\)</span>, <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_i + \Delta x\)</span> for computing the temperature at the next time step <span class="math inline">\(t_n+\Delta t\)</span> for interior points <span class="math inline">\(i=1,\ldots,N\)</span> is given below</p>
<p>\[ T(x_i,t_n+t) = (1-2k)T(x_i,t_n) + k((T(x_{i-1},t_n)+T(x_{i+1},t_n)) \]</p>
<p>where <span class="math inline">\(k\)</span> is a parameter that shall be chosen properly in order for the numerical procedure to be stable.</p>
<p>Note in the formula, the temperature <span class="math inline">\(T(x_i,t_n+\Delta t)\)</span> at the next time step <span class="math inline">\(t_{n+1} = t_n +\Delta t\)</span> can be computed explicitly using the values of <span class="math inline">\(T\)</span> at three points at current time step <span class="math inline">\(t_n\)</span>, which are all known. This allows us to compute all grid values of <span class="math inline">\(T\)</span> at time <span class="math inline">\(t_n+\Delta t\)</span> independent of each other, hence to achieve parallelism.</p>
<p>Let <span class="math inline">\(U_i^n\)</span> denote the value of <span class="math inline">\(T(x_i,t_n)\)</span> at grid points <span class="math inline">\(x_i\)</span>, <span class="math inline">\(i=1,\ldots,N\)</span> at time <span class="math inline">\(t_n\)</span>, we use the short notation</p>
<p>\[ U_i^{n+1} = (1-2k)U_i^n + k(U_{i-1}^n + U_{i+1}^n). \]</p>
<div class="page-columns page-full"><p>for <span class="math inline">\(i=1,\ldots,N\)</span>. This can be translated into the following code with one dimensional two arrays <code>unew[1:N]</code> and <code>u[1:N]</code> holding values at the <span class="math inline">\(N\)</span> grid points at <span class="math inline">\(t_{n+1}\)</span> and <span class="math inline">\(t_n\)</span> respectively<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Note that <code>2k</code> is not a typo, it is a legal Julia expression, meaning <code>2*k</code>.</p></li></div></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i<span class="op">=</span><span class="fl">1</span><span class="op">:</span>N</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    unew[i] <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span><span class="fl">2</span>k)u[i] <span class="op">+</span> <span class="fu">k*</span>(u[i<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> u[i<span class="op">+</span><span class="fl">1</span>])</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This loop in fact can be replaced by the following one line of code using a single array <code>u[1:N]</code></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>u[<span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span><span class="fl">2</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>N<span class="op">-</span><span class="fl">2</span>) <span class="op">+</span> u[<span class="fl">3</span><span class="op">:</span>N])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, vectorized operations on the right hand side take place first before the individual elements on the left hand side are updated.</p>
<p><strong>Serial code</strong>. A serial code is given below. The time evolution loop is at the end of the code.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span>, <span class="bu">Base</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Input parameters</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">65</span>          <span class="co"># Number of end points 1 to n (n-1 intervals).</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="op">-</span><span class="fl">0.0005</span>        <span class="co"># dt &lt;= 0.5*dx^2/a, ignored if set negative</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="fl">10000</span>       <span class="co"># Number of stemps in t.</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>output_freq <span class="op">=</span> <span class="fl">1</span>     <span class="co"># Number of stemps per display.</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>xlim <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,<span class="fl">2</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>xlim[<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>xlim[<span class="fl">2</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>heat_range <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,<span class="fl">2</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>heat_range[<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>heat_range[<span class="fl">2</span>] <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>heat_temp <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the k value</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>dx <span class="op">=</span> (xlim[<span class="fl">2</span>] <span class="op">-</span> xlim[<span class="fl">1</span>])<span class="op">/</span>(n<span class="op">-</span><span class="fl">1</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (dt <span class="op">&gt;</span> <span class="fl">0</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> a<span class="op">*</span>dt<span class="op">/</span>(dx<span class="op">*</span>dx)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create space for u; create coordinates x for demo</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> xlim[<span class="fl">1</span>] <span class="op">.+</span> <span class="fu">dx*</span>(<span class="fu">collect</span>(<span class="fl">1</span><span class="op">:</span>n) <span class="op">.-</span><span class="fl">1</span>);</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,n);</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial condition</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>ix <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">x-&gt;</span>(heat_range[<span class="fl">1</span>] <span class="op">.&lt;</span> x <span class="op">.&amp;&amp;</span> x <span class="op">.&lt;</span> heat_range[<span class="fl">2</span>]),x);</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>@. u[ix] <span class="op">=</span> heat_temp;</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Display plot (it could be really slow on some systems to launch)</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">plot</span>(x,u[<span class="fl">1</span><span class="op">:</span>n],lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the solution over time</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_steps</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the solution for the next time step</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2.0</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>n<span class="op">-</span><span class="fl">2</span>]<span class="op">+</span>u[<span class="fl">3</span><span class="op">:</span>n])</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the solution (comment it out for pro</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="op">%</span> output_freq <span class="op">==</span> <span class="fl">0</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">display</span>(<span class="fu">plot</span>(x,u[<span class="fl">1</span><span class="op">:</span>n],lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span>        </span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Parallel solution</strong>. We divide the domain - the set of grid points - into subdomains and assign each of them and the computational tasks to a worker. That’s the basic idea</p>
<p></p>
<p>Let <span class="math inline">\(P\)</span> be the number of participating processes - workers in Julia’s term. The way of partitioning the domain is not unique. We choose a simple one: each subdomain gets <span class="math inline">\(N \div P\)</span> points and the last one includes the remainder, that is, for subdomain <span class="math inline">\(1\)</span> to <span class="math inline">\(P-1\)</span>, the number of local grid points</p>
<p>\[ N_{} = N P \]</p>
<p>and for the last subdomain</p>
<p>\[ N_P = N P + N P. \]</p>
<p>This is in fact what Julia does for the partition of one dimensional arrays. For example, let <span class="math inline">\(N=17\)</span>. The following code shows how the shared array <code>u[1:N]</code> is “partitioned” on each worker</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="fl">17</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">zeros</span>(N)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="op">=</span> <span class="fu">workers</span>() <span class="co"># Assume we have created 4 workers</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@fetchfrom</span> p <span class="fu">println</span>(<span class="fu">localindices</span>(u))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output of the start and end indices of each subset on each of the workers looks like the following</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 2:    1:4</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 3:    5:8</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 4:    9:12</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">From</span> worker 5:    13:17</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The calculation of</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>u[<span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span><span class="fl">2</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>N<span class="op">-</span><span class="fl">2</span>) <span class="op">+</span> u[<span class="fl">3</span><span class="op">:</span>N])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is now done on each subset of the grid points, as shown in the diagram below</p>
<p></p>
<p>We need to replace the start and end indices with the local ones <code>l1</code> and <code>lN</code></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>u[l1<span class="op">:</span>lN] <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span><span class="fl">2</span>k)<span class="op">*</span>u[l1<span class="op">:</span>lN] <span class="op">+</span> <span class="fu">k*</span>(u[l1<span class="op">-</span><span class="fl">1</span><span class="op">:</span>lN<span class="op">-</span><span class="fl">1</span>) <span class="op">+</span> u[l1<span class="op">+</span><span class="fl">1</span><span class="op">:</span>lN<span class="op">+</span><span class="fl">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note for the left most subset, we need to skip the very first one, as it is the boundary point, no need to compute the solution for. So is for the right most one, we need to skip the very last one.</p>
<p>We define a function <code>update</code> that computes the solution only for the portion that the worker owns it. For demo purpose, we have it compute the local start and end indices as well, which could be set in a different way.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">update</span>(u,me)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the start and end indices</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> <span class="fu">np*</span>(me <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="fl">1</span>;</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    ln <span class="op">=</span> l1 <span class="op">+</span> np <span class="op">+</span> n <span class="op">%</span> num_workers <span class="op">-</span> <span class="fl">1</span>;</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip the left most and right most end points</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> <span class="fl">1</span>) </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        l1 <span class="op">=</span> <span class="fl">2</span>;</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> num_workers)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        ln <span class="op">=</span> n <span class="op">-</span> <span class="fl">1</span>;</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> </span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    u[l1<span class="op">:</span>ln] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2</span>k)<span class="op">*</span>u[l1<span class="op">:</span>ln] <span class="op">+</span> <span class="fu">k*</span>(u[l1<span class="op">-</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">-</span><span class="fl">1</span>]<span class="op">+</span>u[l1<span class="op">+</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">+</span><span class="fl">1</span>])</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now our parallel version of the code looks like the following.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_steps </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">begin</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_workers</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@async</span> <span class="fu">remotecall</span>(update,p<span class="op">+</span><span class="fl">1</span>,u,p);</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span>           </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="op">%</span> output_freq <span class="op">==</span> <span class="fl">0</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">display</span>(<span class="fu">plot</span>(x,u,lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The time evolution for loop is on the control process. Inside the loop, it calls the function <code>update</code> on workers at each time step (in a fork-join fashion). The workers are synchronized after they complete their own computation before moving ahead to the time step. The display is executed on the control process</p>
<blockquote class="blockquote">
<h3 id="exercise-1d-heat-equation-using-shared-arrays" class="anchored">Exercise 1D heat equation using shared arrays</h3>
<ol type="1">
<li>Use the serial code as the base. Write a skeleton of the parallel code</li>
</ol>
</blockquote>
<div class="sourceCode" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Base</span>, <span class="bu">Distributed</span>, <span class="bu">SharedArrays</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Input parameters</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span> <span class="op">...</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the k value</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="op">...</span> <span class="op">...</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set x-coordinates for plot</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="op">...</span> <span class="op">...</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># For demo purpose, set number of workers to 4</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>num_workers <span class="op">=</span> <span class="fu">nworkers</span>() <span class="co"># Number of workder processes</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>np <span class="op">=</span> <span class="fu">div</span>(n,<span class="fu">nprocs</span>())    <span class="co"># Number of points local to the process</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate spaces</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{Float64}</span>(n);</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>u <span class="op">.=</span> <span class="fl">0</span>;</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial condition</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>ix <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">x-&gt;</span>(heat_range[<span class="fl">1</span>] <span class="op">.&lt;</span> x <span class="op">.&amp;&amp;</span> x <span class="op">.&lt;</span> heat_range[<span class="fl">2</span>]),x);</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>@. u[ix] <span class="op">=</span> heat_temp;</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Broadcast parameters to all</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> k<span class="op">=$</span>k</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> n<span class="op">=$</span>n</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> np<span class="op">=$</span>np</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> num_workers<span class="op">=$</span>num_workers</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> l1<span class="op">=</span><span class="fl">1</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> ln<span class="op">=</span><span class="fl">1</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the function update on all processes</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">get_partition</span>(me)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the start and end indices l1, ln (they are global)</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> <span class="op">...</span> </span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    ln <span class="op">=</span> <span class="op">...</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip the left most and right most end points</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> <span class="fl">1</span>) </span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>        l1 <span class="op">=</span> <span class="fl">2</span>;</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> num_workers)</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>        ln <span class="op">=</span> n <span class="op">-</span> <span class="fl">1</span>;</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> </span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">plot</span>(x,u,lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Get partition info</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@async</span> <span class="fu">remotecall_fetch</span>(get_partition,p,p<span class="op">-</span><span class="fl">1</span>)</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Update u in time on workders</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="cf">begin</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_steps </span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">begin</span></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@async</span> <span class="fu">remotecall</span>(update,p,u);</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span>           </span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="op">%</span> output_freq <span class="op">==</span> <span class="fl">0</span>)</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">display</span>(<span class="fu">plot</span>(x,u,lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a><span class="fu">sleep</span>(<span class="fl">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<ol start="2" type="1">
<li>Complete the function <code>get_partition</code></li>
</ol>
</blockquote>
<div class="sourceCode" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">get_partition</span>(me)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the start and end indices</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> <span class="op">...</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    ln <span class="op">=</span> <span class="op">...</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip the left most and right most end points</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> <span class="fl">1</span>) </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        l1 <span class="op">=</span> <span class="fl">2</span>;</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> num_workers)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        ln <span class="op">=</span> n <span class="op">-</span> <span class="fl">1</span>;</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> </span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<ol start="3" type="1">
<li>Write a function <code>update</code> as follows</li>
</ol>
</blockquote>
<div class="sourceCode" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">update</span>(u)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    u[l1<span class="op">:</span>ln] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2</span>k)<span class="op">*</span>u[l1<span class="op">:</span>ln] <span class="op">+</span> <span class="fu">k*</span>(u[l1<span class="op">-</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">-</span><span class="fl">1</span>]<span class="op">+</span>u[l1<span class="op">+</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">+</span><span class="fl">1</span>])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<ol start="4" type="1">
<li>Complete the parallel code and see if you can get the same output (graphical display) as the serial code.</li>
</ol>
</blockquote>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/2023uvic\.netlify\.app\//);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../calendar.html">Calendar</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../newsletter.html">Newsletter</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../contact.html">Contact</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://docs.alliancecan.ca/wiki/Technical_documentation">Wiki</a>
  </li>  
</ul>
      </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/WestDRI">
      <i class="bi bi-github" role="img" aria-label="WestDRI GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/channel/UCfgds4Qf7VFOv4ORRvFFmhw">
      <i class="bi bi-youtube" role="img" aria-label="WestDRI YouTube">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>