<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>UVic Spring School 2023 - DistributedArrays.jl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//img/sfu_favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/sfudrac_logo.png" alt="SFU &amp; DRAC logos" class="navbar-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../bash/index.html">
 <span class="menu-text">Bash</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../hpc/index.html">
 <span class="menu-text">HPC</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_intro/index.html">
 <span class="menu-text">Intro R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_parallel/index.html">
 <span class="menu-text">Parallel R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../julia/index.html">
 <span class="menu-text">Parallel Julia</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../ml/index.html">
 <span class="menu-text">PyTorch</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../scivis/index.html">
 <span class="menu-text">ParaView</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title"><em>On this page:</em></h2>
   
  <ul>
  <li><a href="#distributed-arrays-at-a-glance" id="toc-distributed-arrays-at-a-glance" class="nav-link active" data-scroll-target="#distributed-arrays-at-a-glance">Distributed arrays at a glance</a></li>
  <li><a href="#building-a-distributed-array-from-local-pieces-1" id="toc-building-a-distributed-array-from-local-pieces-1" class="nav-link" data-scroll-target="#building-a-distributed-array-from-local-pieces-1">Building a distributed array from local pieces </a></li>
  <li><a href="#accessing-distributed-arrays" id="toc-accessing-distributed-arrays" class="nav-link" data-scroll-target="#accessing-distributed-arrays">Accessing distributed arrays</a></li>
  <li><a href="#solving-1d-heat-equation-using-distributed-array2" id="toc-solving-1d-heat-equation-using-distributed-array2" class="nav-link" data-scroll-target="#solving-1d-heat-equation-using-distributed-array2">Solving 1D heat equation using distributed array</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DistributedArrays.jl</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="distributed-arrays-at-a-glance" class="level3">
<h3 class="anchored" data-anchor-id="distributed-arrays-at-a-glance">Distributed arrays at a glance</h3>
<p><strong>DistributedArrays</strong> package provides <strong>DArray</strong> object that can be split across several processes (set of workers), either on the same or multiple nodes. This allows use of arrays that are too large to fit in memory on one node. Each process operates on the part of the array that it owns – this provides a very natural way to achieve parallelism for large problems.</p>
<ul>
<li>Each worker can <em>read any elements</em> using their global indices</li>
<li>Each worker can <em>write only to the part that it owns</em> <span class="math inline">\(~\Rightarrow~\)</span> automatic parallelism and safe execution</li>
</ul>
<p>DistributedArrays is not part of the standard library, so usually you need to install it yourself (it will typically write into <code>~/.julia/environments/versionNumber</code> directory):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>] add DistributedArrays</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We need to load DistributedArrays on every worker:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">addprocs</span>(<span class="fl">4</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">DistributedArrays</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float32</span>, n, n);          <span class="co"># distributed 2D array of 0's</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data                                   <span class="co"># can access the entire array</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data[<span class="fl">1</span>,<span class="fl">1</span>], data[n,<span class="fl">5</span>]                   <span class="co"># can use global indices</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>data.dims                              <span class="co"># global dimensions (10, 10)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>data[<span class="fl">1</span>,<span class="fl">1</span>] <span class="op">=</span> <span class="fl">1.0</span>                        <span class="co"># error: cannot write from the control process!</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@spawnat</span> <span class="fl">2</span> data.localpart[<span class="fl">1</span>,<span class="fl">1</span>] <span class="op">=</span> <span class="fl">1.5</span>   <span class="co"># success: can write locally</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s check <code>data</code> distribution across workers:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> i <span class="fu">println</span>(<span class="fu">localindices</span>(data))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>rows, cols <span class="op">=</span> <span class="pp">@fetchfrom</span> <span class="fl">3</span> <span class="fu">localindices</span>(data)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(rows)     <span class="co"># the rows owned by worker 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can only write into <code>data</code> from its “owner” workers using local indices on these workers:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">fillLocalBlock</span>(data)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    h, w <span class="op">=</span> <span class="fu">localindices</span>(data)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iGlobal <span class="kw">in</span> h                         <span class="co"># or collect(h)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        iLoc <span class="op">=</span> iGlobal <span class="op">-</span> h.start <span class="op">+</span> <span class="fl">1</span>         <span class="co"># always starts from 1</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> jGlobal <span class="kw">in</span> w                     <span class="co"># or collect(w)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            jLoc <span class="op">=</span> jGlobal <span class="op">-</span> w.start <span class="op">+</span> <span class="fl">1</span>     <span class="co"># always starts from 1</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc,jLoc] <span class="op">=</span> iGlobal <span class="op">+</span> jGlobal</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> i <span class="fu">fillLocalBlock</span>(data)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>data   <span class="co"># now the distributed array is filled</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">@fetchfrom</span> <span class="fl">3</span> data.localpart    <span class="co"># stored on worker 3</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">minimum</span>(data), <span class="fu">maximum</span>(data)   <span class="co"># parallel reduction</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One-liners to generate distributed arrays:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">dzeros</span>(<span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span>);      <span class="co"># 100^3 distributed array of 0's</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">dones</span>(<span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span>);       <span class="co"># 100^3 distributed array of 1's</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="fu">drand</span>(<span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span>);       <span class="co"># 100^3 uniform [0,1]</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="fu">drandn</span>(<span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span>);      <span class="co"># 100^3 drawn from a Gaussian distribution</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>d[<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cn">e</span> <span class="op">=</span> <span class="fu">dfill</span>(<span class="fl">1.5</span>,<span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span>);   <span class="co"># 100^3 fixed value</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can find more information about the arguments by typing <code>?DArray</code>. For example, you have a lot of control over the DArray’s distribution across workers. Before I show the examples, let’s define a convenient function to show the array’s distribution:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">showDistribution</span>(x<span class="op">::</span><span class="dt">DArray</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@spawnat</span> i <span class="fu">println</span>(<span class="fu">localindices</span>(x))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nworkers</span>()                                  <span class="co"># 4</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="fu">dzeros</span>((<span class="fl">100</span>,<span class="fl">100</span>), <span class="fu">workers</span>()[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>]);   <span class="co"># define only on the first two workers</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">showDistribution</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> <span class="fu">dzeros</span>((<span class="fl">100</span>,<span class="fl">100</span>), <span class="fu">workers</span>()[<span class="fl">1</span><span class="op">:</span><span class="fl">4</span>], [<span class="fl">2</span>,<span class="fl">2</span>]);   <span class="co"># 2x2 decomposition</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">showDistribution</span>(square)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>slab <span class="op">=</span> <span class="fu">dzeros</span>((<span class="fl">100</span>,<span class="fl">100</span>), <span class="fu">workers</span>()[<span class="fl">1</span><span class="op">:</span><span class="fl">4</span>], [<span class="fl">1</span>,<span class="fl">4</span>]);   <span class="co"># 1x4 decomposition</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">showDistribution</span>(slab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can take a local array and distribute it across workers:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cn">e</span> <span class="op">=</span> <span class="fu">fill</span>(<span class="fl">1.5</span>, (<span class="fl">10</span>,<span class="fl">10</span>))   <span class="co"># local array</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>de <span class="op">=</span> <span class="fu">distribute</span>(<span class="cn">e</span>)       <span class="co"># distribute `e` across all workers</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">showDistribution</span>(de)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<h3 id="exercise-darrays.1" class="anchored">Exercise “DArrays.1”</h3>
<p>Using either <code>top</code> or <code>htop</code> command on Uu, study memory usage with DistributedArrays. Are these arrays really distributed across processes? Use a <em>largish</em> array for this: large enough to spot memory usage, but not too large not to exceed physical memory and not to block other participants (especially if you do this on the login node).</p>
</blockquote>
</section>
<section id="building-a-distributed-array-from-local-pieces-1" class="level3 page-columns page-full">
<h3 class="anchored page-columns page-full" data-anchor-id="building-a-distributed-array-from-local-pieces-1">Building a distributed array from local pieces <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;This example was adapted from Ge Baolai’s presentation “Julia: A third perspective - parallel computing explained” (https://www.youtube.com/watch?v=HWLV6oTmfO8&amp;t=2420s), Western University, SHARCNET, 2020.</p></li></div></h3>
<p>Let’s restart Julia with <code>julia</code> (single control process) and load the packages:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">addprocs</span>(<span class="fl">4</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DistributedArrays       </span><span class="co"># important to load this after addprocs()</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">LinearAlgebra</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will define an <span class="math inline">\(8 \times 8\)</span> matrix with the main diagonal and two off-diagonals (<em>tridiagonal</em> matrix). The lines show our matrix distribution across workers:</p>
<p></p>
<p>Notice that with the 2x2 decomposition two of the 4 blocks are also tridiagonal matrices. We’ll define a function to initiate them:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">tridiagonal</span>(n)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    la <span class="op">=</span> <span class="fu">zeros</span>(n,n)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    la[<span class="fu">diagind</span>(la,<span class="fl">0</span>)] <span class="op">.=</span> <span class="fl">2</span>.     <span class="co"># diagind(la,k) provides indices of the kth diagonal of a matrix</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    la[<span class="fu">diagind</span>(la,<span class="fl">1</span>)] <span class="op">.=</span> <span class="op">-</span><span class="fl">1</span>.    <span class="co"># below the main diagonal</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    la[<span class="fu">diagind</span>(la,<span class="op">-</span><span class="fl">1</span>)] <span class="op">.=</span> <span class="op">-</span><span class="fl">1</span>.   <span class="co"># above the main diagonal</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> la</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also need functions to define the other two blocks:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">upperRight</span>(n)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    la <span class="op">=</span> <span class="fu">zeros</span>(n,n)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    la[n,<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>.</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> la</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">lowerLeft</span>(n)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    la <span class="op">=</span> <span class="fu">zeros</span>(n,n)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    la[<span class="fl">1</span>,n] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>.</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> la</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We use these functions to define local pieces on each block and then create a distributed 8x8 matrix on a 2x2 process grid:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>d11 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">2</span> <span class="fu">tridiagonal</span>(<span class="fl">4</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>d21 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">3</span> <span class="fu">lowerLeft</span>(<span class="fl">4</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>d12 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">4</span> <span class="fu">upperRight</span>(<span class="fl">4</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>d22 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">5</span> <span class="fu">tridiagonal</span>(<span class="fl">4</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="fu">DArray</span>(<span class="fu">reshape</span>([d11 d21 d12 d22],(<span class="fl">2</span>,<span class="fl">2</span>)))   <span class="co"># create a distributed 8x8 matrix on a 2x2 process grid</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<h3 id="exercise-darrays.2" class="anchored">Exercise: “DArrays.2”</h3>
<p>Redefine <code>showDistribution()</code> on the control process and run <code>showDistribution(d)</code>.</p>
</blockquote>
<!-- Solution: need to run `using DistributedArrays` on all workers. -->
</section>
<section id="accessing-distributed-arrays" class="level3">
<h3 class="anchored" data-anchor-id="accessing-distributed-arrays">Accessing distributed arrays</h3>
<p>While using distributed array saves memory and allows one to access the entire array in global address, it is tedious and sometimes challenging to do book keeping. For instance, setting values to a specific location in a distributed array is no easy job, as the DistributedArrays package only allows the process that owns the portion of the data to alter the values. Finding the boundary of the portion of data owned by each process is the first step towards setting values at the right locations within the boundaries.</p>
<p>Consider two scenarios in which we are to write a slice of data to an one dimensional array <code>A[istart:iend]</code>:</p>
<ol type="1">
<li>The range <code>istart:iend</code> falls into the range of indices of data owned by a process;</li>
<li>The range <code>istart:iend</code> falls across two adjacent portions of data owned by two different processes.</li>
</ol>
<p>as depicted in the diagram below, the shaped areas represent the portion of the array <code>A</code> to be updated</p>
<p></p>
<p>To set the value of <code>A[i]</code>, we need to use the method <code>.localpart</code></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>A.localpart[i<span class="op">-</span>offset<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>offset</code> is the offset of the global index of the first element in the portion owned by the current worker process, <code>i-offset+1</code> gives the local index relative to the first element in the local portion.</p>
<p>We wish this can be improved in the future, such that we can simply do</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>A[i] <span class="op">=</span> value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But the time being, this is the way it is.</p>
<p>Now let’s have a look at how we to accomplish the task of setting a slice of data <code>A[istart:iend]</code>. Logically we need perform the following</p>
<ol type="1">
<li>On each worker, find the lower and upper indices <code>ilo</code> and <code>iup</code>, respectively, of the data portion owned by the worker process;</li>
<li>Find the intersection <code>iset</code> of indices of range <code>istart</code> and <code>iend</code> and the set of indices of local portion of data ranging from <code>ilo</code> to `iup;</li>
<li>Find the range of local indices of <code>iset</code></li>
</ol>
<div class="sourceCode" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>lstart <span class="op">=</span> iset[<span class="fl">1</span>] <span class="op">-</span> ilo <span class="op">+</span> <span class="fl">1</span>;</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>lend <span class="op">=</span> iset[<span class="fl">2</span>] <span class="op">-</span> ilo <span class="op">+</span> <span class="fl">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>Set the values with</li>
</ol>
<div class="sourceCode" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>A.localpart[lstart<span class="op">:</span>lend] <span class="op">=</span> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To practice this, one may do the following exercise</p>
<blockquote class="blockquote">
<h3 id="exercise-setting-a-slice-of-values-in-a-distributed-array" class="anchored">Exercise: Setting a slice of values in a distributed array</h3>
<p>Run Julia with 4 worker processes. Create a distributed array <code>u</code> of length <code>n=17</code>, initialized with zeros. Set slice of <code>u[7:11]</code> to 1.0, as shown in the diagram below On may see the actual partitions by running the following commands</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> p <span class="fu">println</span>(<span class="fu">localindices</span>(u))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Hint: The array <code>u</code> is partitioned into four subarrays. Perform the following operations on each worker. 1. For each subarray, find the lower and upper indices of the subarray <code>ilo</code> and <code>iup</code>; 2. For each subarray, find the start and end indices that fall in <code>[7:11]</code>, that is, a subset of <code>[7:11]</code> in the partition. One may use the following operations</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>iset <span class="op">=</span> <span class="fu">intersect</span>(<span class="fu">Vector</span>(<span class="fl">7</span><span class="op">:</span><span class="fl">11</span>),<span class="fu">Vector</span>(ilo,iup));</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># If iset is empty, skip</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>istart <span class="op">=</span> iset[<span class="fl">1</span>];</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>iend <span class="op">=</span> iset[<span class="kw">end</span>];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Set the value 1.0 to the slices with local indices</li>
</ol>
<div class="sourceCode" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>lstart <span class="op">=</span> istart <span class="op">-</span> ilo <span class="op">+</span> <span class="fl">1</span>;</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>lend <span class="op">=</span> iend <span class="op">-</span> ilo <span class="op">+</span> <span class="fl">1</span>;</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>u.localpart[lstart<span class="op">:</span>lend] <span class="op">.=</span> <span class="fl">1.0</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>The operations need to be performed on each worker, unless you can locate the subarrays that contain the slice of indices <code>[7:11]</code> otherwise.</li>
</ol>
</blockquote>
<p>The same idea can be extended to multidimensional arrays.</p>
<blockquote class="blockquote">
<h3 id="exercise-setting-values-in-a-submatrix" class="anchored">Exercise: Setting values in a submatrix</h3>
<p>Homework: Write a function <code>setval(a,va1,istart,iend,jstart,jend)</code> that will set the value <code>val</code> in a distributed array <code>a</code> at <code>a[istart:iend,jstart:jend]</code>.</p>
</blockquote>
</section>
<section id="solving-1d-heat-equation-using-distributed-array2" class="level3 page-columns page-full">
<h3 class="anchored page-columns page-full" data-anchor-id="solving-1d-heat-equation-using-distributed-array2">Solving 1D heat equation using distributed array<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;This example is included in some of the SHARCNET training courses including Modern Fortran, Python, MPI and a few others.</p></li></div></h3>
<p>Consider a (simplified) physics problem: A rod of length <span class="math inline">\([-L,L]\)</span> heated in the middle, then the heat source is removed. The temperature distribution <span class="math inline">\(T(x,t)\)</span> across the rod over time can be simulated by the following equation</p>
<p>\[ T(x,t+t) = T(x-x,t) + T(x+x,t) \]</p>
<p>on a set of evenly spaced points apart by <span class="math inline">\(\Delta x\)</span>. The initial condition is shown in the diagram below. At <span class="math inline">\(t=0\)</span>, <span class="math inline">\(T(x,0) = T_0\)</span> for <span class="math inline">\(-h \leq x \leq h\)</span> and <span class="math inline">\(T(x,0) = 0\)</span> elsewhere.</p>
<p></p>
<p>At both ends, we impose the boundary conditions <span class="math inline">\(T(-L,t)=0\)</span> and <span class="math inline">\(T(L,t)=0\)</span>.</p>
<p>The solution of the temperature across the rod is a bell shaped curve being flattened over time. The figure below shows a snapshot of the solution (with <span class="math inline">\(T_0 = 1\)</span>) on an interval <span class="math inline">\([-1,1]\)</span> at certain time.</p>
<p></p>
<p>This example is used in many of our training courses, for example, MPI, Fortran and Python courses to illustrate parallel processing in advanced research computing. A more “accurate” formula involving three spatial points <span class="math inline">\(x_i - \Delta x\)</span>, <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_i + \Delta x\)</span> for computing the temperature at the next time step <span class="math inline">\(t_n+\Delta t\)</span> for interior points <span class="math inline">\(i=1,\ldots,N\)</span> is given below</p>
<p>\[ T(x_i,t_n+t) = (1-2k)T(x_i,t_n) + k((T(x_{i-1},t_n)+T(x_{i+1},t_n)) \]</p>
<p>where <span class="math inline">\(k\)</span> is a parameter that shall be chosen properly in order for the numerical procedure to be stable.</p>
<p>Note in the formula, the temperature <span class="math inline">\(T(x_i,t_n+\Delta t)\)</span> at the next time step <span class="math inline">\(t_{n+1} = t_n +\Delta t\)</span> can be computed explicitly using the values of <span class="math inline">\(T\)</span> at three points at current time step <span class="math inline">\(t_n\)</span>, which are all known. This allows us to compute all grid values of <span class="math inline">\(T\)</span> at time <span class="math inline">\(t_n+\Delta t\)</span> independent of each other, hence to achieve parallelism.</p>
<p>Let <span class="math inline">\(U_i^n\)</span> denote the value of <span class="math inline">\(T(x_i,t_n)\)</span> at grid points <span class="math inline">\(x_i\)</span>, <span class="math inline">\(i=1,\ldots,N\)</span> at time <span class="math inline">\(t_n\)</span>, we use the short notation</p>
<p>\[ U_i^{n+1} = (1-2k)U_i^n + k(U_{i-1}^n + U_{i+1}^n) \]</p>
<div class="page-columns page-full"><p>for <span class="math inline">\(i=1,\ldots,N\)</span>. This can be translated into the following code with two one dimensional arrays <code>unew[1:N]</code> and <code>u[1:N]</code> holding values at the <span class="math inline">\(N\)</span> grid points at <span class="math inline">\(t_{n+1}\)</span> and <span class="math inline">\(t_n\)</span> respectively<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;Note that <code>2k</code> is not a typo, it is a legal Julia expression, meaning <code>2*k</code>.</p></li></div></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i<span class="op">=</span><span class="fl">1</span><span class="op">:</span>N</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    unew[i] <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span><span class="fl">2</span>k)u[i] <span class="op">+</span> <span class="fu">k*</span>(u[i<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> u[i<span class="op">+</span><span class="fl">1</span>])</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This loop in fact can be replaced by the following one line of code using a single array <code>u[1:N]</code></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>u[<span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span><span class="fl">2</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>N<span class="op">-</span><span class="fl">2</span>) <span class="op">+</span> u[<span class="fl">3</span><span class="op">:</span>N])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, vectorized operations on the right hand side take place first before the individual elements on the left hand side are updated.</p>
<p><strong>Serial code</strong>. A serial code is given below. The time evolution loop is at the end of the code.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span>, <span class="bu">Base</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Input parameters</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">65</span>          <span class="co"># Number of end points 1 to n (n-1 intervals).</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="op">-</span><span class="fl">0.0005</span>        <span class="co"># dt &lt;= 0.5*dx^2/a, ignored if set negative</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="fl">10000</span>       <span class="co"># Number of stemps in t.</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>output_freq <span class="op">=</span> <span class="fl">1</span>     <span class="co"># Number of stemps per display.</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>xlim <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,<span class="fl">2</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>xlim[<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>xlim[<span class="fl">2</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>heat_range <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,<span class="fl">2</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>heat_range[<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>heat_range[<span class="fl">2</span>] <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>heat_temp <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the k value</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>dx <span class="op">=</span> (xlim[<span class="fl">2</span>] <span class="op">-</span> xlim[<span class="fl">1</span>])<span class="op">/</span>(n<span class="op">-</span><span class="fl">1</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (dt <span class="op">&gt;</span> <span class="fl">0</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> a<span class="op">*</span>dt<span class="op">/</span>(dx<span class="op">*</span>dx)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create space for u; create coordinates x for demo</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> xlim[<span class="fl">1</span>] <span class="op">.+</span> <span class="fu">dx*</span>(<span class="fu">collect</span>(<span class="fl">1</span><span class="op">:</span>n) <span class="op">.-</span><span class="fl">1</span>);</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,n);</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial condition</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>ix <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">x-&gt;</span>(heat_range[<span class="fl">1</span>] <span class="op">.&lt;</span> x <span class="op">.&amp;&amp;</span> x <span class="op">.&lt;</span> heat_range[<span class="fl">2</span>]),x);</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>@. u[ix] <span class="op">=</span> heat_temp;</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Display plot (it could be really slow on some systems to launch)</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">plot</span>(x,u[<span class="fl">1</span><span class="op">:</span>n],lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the solution over time</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_steps</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the solution for the next time step</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2.0</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>n<span class="op">-</span><span class="fl">2</span>]<span class="op">+</span>u[<span class="fl">3</span><span class="op">:</span>n])</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the solution (comment it out for pro</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="op">%</span> output_freq <span class="op">==</span> <span class="fl">0</span>)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">display</span>(<span class="fu">plot</span>(x,u[<span class="fl">1</span><span class="op">:</span>n],lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span>        </span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Parallel code</strong>. To demonstrate the use of distributed arrays, we implement the parallel version of the code using a distributed array <code>u</code> to store the solution. Since we can’t write directly to a distributed array, the loop</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_steps</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the solution for the next time step</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2.0</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>n<span class="op">-</span><span class="fl">2</span>]<span class="op">+</span>u[<span class="fl">3</span><span class="op">:</span>n])</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the solution (comment it out for pro</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="op">%</span> output_freq <span class="op">==</span> <span class="fl">0</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">display</span>(<span class="fu">plot</span>(x,u[<span class="fl">1</span><span class="op">:</span>n],lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span>        </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>needs to be modified. Note the array <code>u</code> is distributed across workers. The grid is partitioned accordingly. The following diagram illustrates the partition of the grid and corresponding solution array <code>u</code></p>
<p></p>
<p>We are going to modify the line</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2.0</span>k)<span class="op">*</span>u[<span class="fl">2</span><span class="op">:</span>n<span class="op">-</span><span class="fl">1</span>] <span class="op">+</span> <span class="fu">k*</span>(u[<span class="fl">1</span><span class="op">:</span>n<span class="op">-</span><span class="fl">2</span>]<span class="op">+</span>u[<span class="fl">3</span><span class="op">:</span>n])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>such that the computation is done on each worker locally.</p>
<p>The indices on the right hand side need to be replaced by the start and end indices on the current process. On the left hand side, as we’ve seen before, we need to use the function <code>localindices(local_start, local_end)</code> to replace the global index (which is a huge draw back with the current design of the package DistributedArrays)</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ll1 <span class="op">=</span> <span class="op">...</span> <span class="co"># Local start index</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>lln <span class="op">=</span> <span class="op">...</span> <span class="co"># Local end index</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>u.localpart[ll1<span class="op">:</span>lln] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2.0</span><span class="op">*</span>k)<span class="op">*</span>u[l1<span class="op">:</span>ln] <span class="op">+</span> <span class="fu">k*</span>(u[l1<span class="op">-</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">-</span><span class="fl">1</span>]<span class="op">+</span>u[l1<span class="op">+</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">+</span><span class="fl">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>.localpart</code> is a method associated with the distributed array object that allows us to access and alter the values of the portion owned by the current worker process.</p>
<p>To avoid retrieving the start and end indices <code>l1</code> and <code>ln</code> on each worker repeatedly during the time loop, we extract that information before the time loop using a function</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">get_partition_info</span>()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> u;</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> l1, ln, ilo, iup;</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the lower and upper boundary indices from distributed array</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">localindices</span>(u);</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    index_range <span class="op">=</span> idx[<span class="fl">1</span>];</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    ilo <span class="op">=</span> index_range.start;</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    iup <span class="op">=</span> index_range.stop;</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> ilo;</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    ln <span class="op">=</span> iup;</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Local compute end indices (skip the left and right most end points)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    me <span class="op">=</span> <span class="fu">myid</span>() <span class="op">-</span> <span class="fl">1</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> <span class="fl">1</span>) </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        l1 <span class="op">=</span> <span class="fl">2</span>;</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (me <span class="op">==</span> num_workers)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        ln <span class="op">=</span> iup <span class="op">-</span> <span class="fl">1</span>;</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@async</span> <span class="fu">remotecall_fetch</span>(get_partition_info, p)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note we use the julia function <code>localindices()</code> to get the index range of the distributed array <code>u</code>. It returns a range, we then use the method <code>.start</code> and <code>.stop</code> to get the lower and upper indices <code>ilo</code> and <code>iup</code>, respectively, of the array owned by the current worker process. We adjust the start and end indices for the very first and very end of the sub-grid for skipping the boundary point there.</p>
<p>We also define a function <code>update</code> that computes the solution</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">update</span>()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> u, ilo, iup, l1, ln;</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> k;</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute updated solution for the next time steop</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The line below does not work: method setting value not defined</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#u[l1:ln] = (1.0-2.0*k)*u[l1:ln] + k*(u[l1-1:ln-1]+u[l1+1:ln+1])</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    ll1 <span class="op">=</span> l1 <span class="op">-</span> ilo <span class="op">+</span> <span class="fl">1</span>;</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    lln <span class="op">=</span> ln <span class="op">-</span> ilo <span class="op">+</span> <span class="fl">1</span>;</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    u.localpart[ll1<span class="op">:</span>lln] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span><span class="fl">2.0</span><span class="op">*</span>k)<span class="op">*</span>u[l1<span class="op">:</span>ln] <span class="op">+</span> <span class="fu">k*</span>(u[l1<span class="op">-</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">-</span><span class="fl">1</span>]<span class="op">+</span>u[l1<span class="op">+</span><span class="fl">1</span><span class="op">:</span>ln<span class="op">+</span><span class="fl">1</span>])</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Another tricky task we need to accomplish is setting initial condition in <code>u</code>. We need to locate the range of indices corresponding to the condition</p>
<p>\[ T(x,0) = 1,&nbsp;&nbsp; -h x h. \]</p>
<p>We’ve done such in the previous exercise. We leave it to the reader as an exercise. The skeleton of the code is shown below</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Base</span>, <span class="bu">Distributed</span>, <span class="bu">DistributedArrays</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Input parameters</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span> <span class="op">...</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set x-coordinates for plot</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> xlim[<span class="fl">1</span>] <span class="op">.+</span> <span class="fu">dx*</span>(<span class="fu">collect</span>(<span class="fl">1</span><span class="op">:</span>n) <span class="op">.-</span><span class="fl">1</span>);</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate spaces</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">DistributedArrays</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>,n);</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Broadcast parameters to all</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="op">...</span> <span class="op">...</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Define gloabl vars and functions on all worker processes</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">Distributed</span>, <span class="bu">DistributedArrays</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> ilo<span class="op">=</span><span class="fl">1</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> iup<span class="op">=</span><span class="fl">1</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> l1<span class="op">=</span><span class="fl">1</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> ln<span class="op">=</span><span class="fl">1</span> <span class="co"># Local start and end indices</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Get lower and upper indices of array u owned by this process</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">get_partition_info</span>()</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span> <span class="op">...</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the function to compute the soluton on a process</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">update</span>()</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span> <span class="op">...</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial condition</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>ihot <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">x-&gt;</span>(heat_range[<span class="fl">1</span>] <span class="op">.&lt;</span> x <span class="op">.&amp;&amp;</span> x <span class="op">.&lt;</span> heat_range[<span class="fl">2</span>]),x);</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> ihot<span class="op">=$</span>ihot</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the initial condition within this process</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">set_init_cond</span>()</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span> <span class="op">...</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize variables and set initial conditions</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@async</span> <span class="fu">remotecall_fetch</span>(get_partition_info,p)</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@async</span> <span class="fu">remotecall_fetch</span>(set_init_cond,p)</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the initial value of u</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>,n)</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>v <span class="op">.=</span> u;</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">plot</span>(x,v,lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Update u in time on workers</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j<span class="op">=</span><span class="fl">1</span><span class="op">:</span>num_steps </span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">begin</span></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@async</span> <span class="fu">remotecall_fetch</span>(update,p);</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span>           </span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="op">%</span> output_freq <span class="op">==</span> <span class="fl">0</span>)</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>        v <span class="op">.=</span> u;</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">display</span>(<span class="fu">plot</span>(x,v,lw<span class="op">=</span><span class="fl">3</span>,ylim<span class="op">=</span>(<span class="fl">0</span>,<span class="fl">1</span>),label<span class="op">=</span>(<span class="st">"u"</span>)))</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A complete sample parallel can be found {{&lt;a “/files/heat1d_darray.jl” “here”&gt;}}.</p>
<p><strong>Technical Points:</strong> This is a toy example for the demonstration of domain decomposition in one dimensional case. Because of the lack of enough computational work on each subdomain, the overhead due to the underlying data communications necessary between adjacent array elements may dominate the execution time, hence one may hardly observe any gain using multiple cores.</p>
<p>If one attempts to increase number of grid points to increase the amount of work, an unexpected numerical instability problem can occur. The explicit finite difference scheme suffers from a major drawback of instability. It can be shown theoretically that if <span class="math inline">\(k \ge 0.5\)</span> or for a given grid size <span class="math inline">\(\Delta t \ge 0.5\Delta x^2\)</span>, the solution of <span class="math inline">\(U_i^{n+1}\)</span> will quickly go divergent wildly. The following graph shows when <span class="math inline">\(k=0.52\)</span>, the solution starts to diverge after 20 steps.</p>
<p></p>
<p>In other words, there is a constraint on the sizes of time step and grid size. Implicit methods are preferred in practice. One may refer to works on the numerical solution of partial differential equations for details.</p>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/2023uvic\.netlify\.app\//);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../calendar.html">Calendar</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../newsletter.html">Newsletter</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../contact.html">Contact</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://docs.alliancecan.ca/wiki/Technical_documentation">Wiki</a>
  </li>  
</ul>
      </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/WestDRI">
      <i class="bi bi-github" role="img" aria-label="WestDRI GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/channel/UCfgds4Qf7VFOv4ORRvFFmhw">
      <i class="bi bi-youtube" role="img" aria-label="WestDRI YouTube">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>